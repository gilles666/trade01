<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Top 20 Coinbase — % hausse 24h + Confiance + Market Cap</title>
<style>
:root{--bg:#0f1220;--card:#171a2b;--text:#e8eaf6;--muted:#9aa0b4;--green:#3ddc97;--red:#ff6b6b;--accent:#7c8cff;--border:#232643}
*{box-sizing:border-box}
body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0e1120,#0a0d17 60%);color:var(--text);padding:24px}
header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin-bottom:16px}
h1{font-size:20px;margin:0}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.wrap{background:rgba(23,26,43,.6);backdrop-filter:saturate(1.2) blur(6px);border:1px solid var(--border);border-radius:14px;overflow:hidden}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{text-align:left;font-size:12px;letter-spacing:.02em;color:var(--muted);padding:12px 14px;background:rgba(124,140,255,.06);position:sticky;top:0;z-index:1}
tbody td{padding:10px 14px;border-top:1px solid var(--border)}
tbody tr:hover{background:rgba(124,140,255,.05)}
.num{font-variant-numeric:tabular-nums;text-align:right}
.sym{color:var(--muted)}
.pos{color:var(--green);font-weight:600}
.neg{color:var(--red);font-weight:600}
.badge{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
@media(max-width:700px){.hide-sm{display:none} body{padding:16px} h1{font-size:18px} tbody td, thead th{padding:10px}}
</style>
</head>
<body>
<header>
  <h1>Top 20 — % de hausse (24h) · Coinbase v3</h1>
  <span id="lastUpdate" class="pill">Dernière maj: —</span>
  <span id="nextIn" class="pill">Prochaine maj dans: —</span>
  <button id="refreshBtn" class="btn">↻ Actualiser</button>
</header>

<div class="wrap">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Actif</th>
        <th class="hide-sm">Prix</th>
        <th class="hide-sm">Market Cap</th>
        <th class="hide-sm">Vol 24h</th>
        <th class="num">% 24h</th>
        <th class="num">% Confiance</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="7" style="padding:18px;color:#9aa0b4">Chargement…</td></tr>
    </tbody>
  </table>
</div>

<footer style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)">
  <div>Sources : Coinbase Exchange (prix/vol.) · CoinCap (market cap)</div>
  <div><small>Auto-refresh: 5 min</small></div>
</footer>

<script>
(async function(){
  const EX = 'https://api.exchange.coinbase.com';
  const COINCAP = 'https://api.coincap.io/v2/assets?limit=2000'; // marketCapUsd + symbol
  const tbody = document.getElementById('tbody');
  const lastUpdate = document.getElementById('lastUpdate');
  const nextIn = document.getElementById('nextIn');
  const refreshBtn = document.getElementById('refreshBtn');

  // ===== Formatters
  const fmtUSD = v => isFinite(+v)? new Intl.NumberFormat('fr-FR',{style:'currency',currency:'USD',maximumFractionDigits:(+v>=1?2:6),minimumFractionDigits:(+v>=1?2:4)}).format(+v):'—';
  const fmtCompact = v => isFinite(+v)? new Intl.NumberFormat('fr-FR',{notation:'compact',maximumFractionDigits:2}).format(+v):'—';
  const fmtPct = v => isFinite(+v)? (+v).toFixed(2)+' %':'—';
  const toLocal = t => new Date(t).toLocaleString('fr-FR',{hour12:false});

  // ===== Refresh cadence
  let timer=null, countdown=0;
  function startCountdown(sec=300){
    countdown=sec; updateCountdown();
    if (timer) clearInterval(timer);
    timer=setInterval(()=>{ countdown--; updateCountdown(); if(countdown<=0){clearInterval(timer); load();} },1000);
  }
  function updateCountdown(){
    const m=Math.floor(countdown/60), s=String(countdown%60).padStart(2,'0');
    nextIn.textContent=`Prochaine maj dans: ${m}:${s}`;
  }

  // ===== Helpers HTTP
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  async function fetchJSON(url, init={}) {
    const res = await fetch(url, { ...init, headers: { 'Accept': 'application/json', ...(init.headers||{}) }, cache:'no-store' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${url}`);
    return res.json();
  }

  // ===== Confidence model (heuristique 0..100)
  function confidencePct(features){
    const {mom60, volX, trendGreen, proxHigh} = features; // chacun 0..1
    const clamp = (x)=> Math.max(0, Math.min(1, x));
    const score =
      0.35*clamp(mom60) +
      0.30*clamp(volX) +
      0.20*clamp(trendGreen) +
      0.15*clamp(proxHigh);
    return Math.round(score*100);
  }

  // ==== Market Cap map from CoinCap (symbol -> marketCapUsd)
  async function buildMarketCapMap(){
    try{
      const data = await fetchJSON(COINCAP);
      const map = {};
      for (const a of (data.data||[])){
        const sym = (a.symbol||'').toUpperCase();
        const mc = +a.marketCapUsd;
        if (sym && isFinite(mc)) {
          // keep the largest market cap if duplicates
          map[sym] = Math.max(map[sym]||0, mc);
        }
      }
      return map;
    }catch(e){
      return {};
    }
  }

  async function load(){
    refreshBtn.disabled = true;
    try{
      // 0) Market cap map (CoinCap)
      const mcMapPromise = buildMarketCapMap();

      // 1) Liste des produits (USD/USDT spot actifs)
      const products = await fetchJSON(`${EX}/products`);
      const spot = products.filter(p =>
        (p.status === 'online' || p.status === 'online_trading') &&
        (p.quote_currency === 'USD' || p.quote_currency === 'USDT') &&
        !p.trading_disabled && !p.cancel_only && !p.post_only
      );

      // 2) Volume résumé pour tous (24h & 30j) — pas strictement nécessaire mais utile
      let volMap = {};
      try{
        const volSum = await fetchJSON(`${EX}/products/volume-summary`);
        for (const row of (volSum||[])) {
          volMap[row.product_id] = { v24:+row.volume_24h || 0, v30:+row.volume_30day || 0 };
        }
      }catch(e){ /* optionnel */ }

      // 3) Pré-sélection par volume 24h
      const topByVol = spot
        .map(p => ({...p, v24: (volMap[p.id]?.v24)||0}))
        .sort((a,b)=> b.v24 - a.v24)
        .slice(0,150);

      // 4) Stats 24h pour calculer % et vol 24h
      async function getStatsBatch(list){
        const out=[];
        for (const p of list){
          try{
            const s = await fetchJSON(`${EX}/products/${encodeURIComponent(p.id)}/stats`);
            const open = +s.open, last= +s.last, high= +s.high, low= +s.low, volBase = +s.volume; // vol base sur 24h
            const changePct = (isFinite(open) && open>0 && isFinite(last)) ? ((last-open)/open)*100 : NaN;
            // Convertit volume base -> USD (si USDT, approx = USD)
            const volUsd = isFinite(volBase) && isFinite(last) ? volBase * last : NaN;
            out.push({product:p, changePct, last, high, low, volBase, volUsd});
          }catch(e){ /* ignore */}
          await sleep(180);
        }
        return out;
      }
      const stats = await getStatsBatch(topByVol);

      // 5) Tri par % 24h décroissant et sélection
      const movers = stats
        .filter(x => isFinite(x.changePct) && x.changePct > 0)
        .sort((a,b)=> b.changePct - a.changePct)
        .slice(0,28);

      // 6) Enrichir confiance via bougies 5m (~1h)
      async function enrich(item){
        const pid = item.product.id;
        let mom60=0, volX=0, trendGreen=0, proxHigh=0;

        try{
          const now = Date.now();
          const end = new Date(now).toISOString();
          const start = new Date(now - 65*60*1000).toISOString();
          const candles = await fetchJSON(`${EX}/products/${encodeURIComponent(pid)}/candles?granularity=300&start=${start}&end=${end}`);
          const cs = (candles||[]).sort((a,b)=> a[0]-b[0]);
          if (cs.length>=2){
            const first = cs[0], lastC = cs[cs.length-1];
            const p0 = +first[3]; // open
            const p1 = +lastC[4]; // close
            mom60 = isFinite(p0)&&p0>0&&isFinite(p1)? Math.max(-1, Math.min(1, (p1-p0)/p0*5)) : 0;
            const greens = cs.filter(c => (+c[4])>(+c[3])).length;
            trendGreen = greens / cs.length;
          }
        }catch(e){}

        // Volume multiple vs moyenne 30j (si dispo)
        const vm = volMap[item.product.id];
        if (vm && vm.v30>0){
          const avgDaily = vm.v30/30;
          volX = Math.min(1, (vm.v24/avgDaily)/3);
        }

        // Proximité du plus haut 24h
        if (isFinite(item.high) && isFinite(item.low) && item.high>item.low && isFinite(item.last)){
          const rng = item.high - item.low;
          proxHigh = Math.max(0, Math.min(1, (item.last - item.low)/rng));
        }

        const conf = confidencePct({mom60, volX, trendGreen, proxHigh});
        return { ...item, conf };
      }

      const enriched = [];
      for (const m of movers){ enriched.push(await enrich(m)); await sleep(120); }

      // 7) Ajoute Market Cap via CoinCap (par symbole)
      const mcMap = await mcMapPromise;
      const withMc = enriched.map(x => ({
        ...x,
        marketCapUsd: mcMap[(x.product.base_currency||'').toUpperCase()] || NaN
      }));

      // 8) Top 20 final
      const rows = withMc
        .sort((a,b)=> b.changePct - a.changePct)
        .slice(0,20);

      render(rows);
      lastUpdate.textContent = `Dernière maj: ${toLocal(Date.now())}`;
      startCountdown(300);
      refreshBtn.disabled = false;

    }catch(err){
      tbody.innerHTML = `<tr><td colspan="7" style="padding:18px;color:#ffb4b4">Erreur: ${err.message}. Nouvelle tentative dans 60s…</td></tr>`;
      startCountdown(60);
      refreshBtn.disabled = false;
    }
  }

  function render(rows){
    if (!rows.length){ tbody.innerHTML = `<tr><td colspan="7" style="padding:18px;color:#9aa0b4">Aucune donnée</td></tr>`; return; }
    tbody.innerHTML = rows.map((r,i)=>{
      const p = r.product;
      const asset = `${p.base_currency}-${p.quote_currency}`;
      const pos = r.changePct>=0;
      const mc = isFinite(r.marketCapUsd)? fmtCompact(r.marketCapUsd) : '—';
      const vol = isFinite(r.volUsd)? fmtCompact(r.volUsd) : '—';
      return `
      <tr>
        <td>${i+1}</td>
        <td>
          <div style="display:flex;gap:10px;align-items:center">
            <div style="width:8px;height:8px;border-radius:50%;background:var(--accent);opacity:.7"></div>
            <div>
              <div>${p.base_currency} <span class="sym">(${asset})</span></div>
              <div class="sym hide-sm" style="font-size:12px">
                <a href="https://exchange.coinbase.com/trade/${encodeURIComponent(asset)}" target="_blank" style="color:var(--accent)">Ouvrir sur Coinbase</a>
              </div>
            </div>
          </div>
        </td>
        <td class="hide-sm num">${fmtUSD(r.last)}</td>
        <td class="hide-sm num">${mc}</td>
        <td class="hide-sm num">${vol}</td>
        <td class="num ${pos?'pos':'neg'}">${fmtPct(r.changePct)}</td>
        <td class="num"><strong>${r.conf} %</strong></td>
      </tr>`;
    }).join('');
  }

  document.getElementById('refreshBtn').addEventListener('click', load);
  document.addEventListener('visibilitychange', ()=>{ if (!document.hidden && countdown < 5) load(); });

  load();
})();
</script>
</body>
</html>
