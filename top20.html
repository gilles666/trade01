<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto â€“ filtre par fenÃªtre & % hausse</title>
  <style>
    :root { --bg:#0b1220; --panel:#121a2b; --accent:#5eead4; --muted:#94a3b8; --text:#e2e8f0; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--bg),rgba(11,18,32,0.8));backdrop-filter:saturate(1.2) blur(6px);}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    select,button,input{background:var(--panel);border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:12px}
    select:focus,button:focus,input:focus{outline:2px solid var(--accent)}
    button{cursor:pointer}
    .status{font-size:14px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:16px}
    .card{grid-column:span 12;background:linear-gradient(180deg,var(--panel),rgba(18,26,43,.8));border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;display:flex;justify-content:space-between;align-items:center}
    @media (min-width:700px){.card{grid-column:span 6}}
    @media (min-width:980px){.card{grid-column:span 4}}
    .sym{font-weight:700;font-size:18px}
    .name{font-size:13px;color:var(--muted)}
    .price{font-variant-numeric:tabular-nums}
    .pct{font-variant-numeric:tabular-nums;font-weight:700}
    .pct.up{color:#22c55e}
    .pct.down{color:#ef4444}
    .small{font-size:12px;color:var(--muted)}
    .footer{display:flex;gap:10px;align-items:center;margin-top:8px}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(94,234,212,.08);border:1px solid rgba(94,234,212,.25);color:var(--accent)}
    .right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="toolbar">
        <h1 style="margin:0;font-size:18px">ðŸ“ˆ Crypto â€“ % de hausse filtrÃ© V7</h1>
        <div style="flex:1 1 auto"></div>
        <label class="small">FenÃªtre:</label>
        <select id="windowSelect" title="FenÃªtre de calcul du %">
          <option value="24h" selected>24h</option>
          <option value="12h">12h</option>
          <option value="6h">6h</option>
          <option value="3h">3h</option>
          <option value="1h">1h</option>
        </select>
        <label class="small">Seuil %:</label>
        <input id="thresholdInput" type="number" step="0.1" min="0" value="1" style="width:90px" />
        <button id="refreshBtn">RafraÃ®chir</button>
        <button id="csvBtn">Exporter CSV</button>
      </div>
      <div class="status" id="status">PrÃªt.</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid" id="list"></div>
  </main>

  <script>
  // ====== CONFIG ======
  const WORKER_URL = 'https://spring-mud-37a1.gilles-e74.workers.dev/';
  // Si votre worker supporte un paramÃ¨tre comme ?window=24h, il sera utilisÃ©.

  // ====== UTIL ======
  const ms = { '1h': 1*3600e3, '3h': 3*3600e3, '6h': 6*3600e3, '12h': 12*3600e3, '24h': 24*3600e3 };
  const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 });
  const money = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits: 6 });

  function nowUtc(){ return Date.now(); }

  function pickPct(item, window){
    // Essaie d'extraire un % dÃ©jÃ  calculÃ© selon la fenÃªtre
    const map = {
      '1h': ['pct_1h','change_1h','price_change_percentage_1h_in_currency','pct1h'],
      '3h': ['pct_3h','change_3h','pct3h'],
      '6h': ['pct_6h','change_6h','pct6h'],
      '12h':['pct_12h','change_12h','pct12h'],
      '24h':['pct_24h','change_24h','price_change_percentage_24h','price_change_percentage_24h_in_currency','pct24h']
    };
    const keys = map[window] || [];
    for (const k of keys){
      if (item[k] !== undefined && item[k] !== null){
        const v = Number(item[k]);
        if (!Number.isNaN(v)) return v;
      }
    }
    return null;
  }

  function pctFromHistory(item, window){
    // Tente de calculer le % depuis un historique si prÃ©sent
    // On cherche un tableau d'objets { t: timestamp(ms|s), p: price } ou similaire
    const series = item.history || item.prices || item.candles || item.ohlc || null;
    if (!Array.isArray(series) || series.length === 0) return null;

    const targetAgo = ms[window] || ms['24h'];
    const now = nowUtc();

    function getTs(x){
      const t = x.t ?? x.time ?? x.timestamp ?? x[0];
      if (t==null) return null;
      // seconds -> ms si besoin
      return (t < 2e10) ? t*1000 : t;
    }
    function getPrice(x){ return x.p ?? x.price ?? x.close ?? x[1] ?? null; }

    let current = null, past = null, minDeltaNow = Infinity, minDeltaPast = Infinity;
    for (const x of series){
      const t = getTs(x); const p = Number(getPrice(x));
      if (!t || Number.isNaN(p)) continue;
      const dNow = Math.abs(now - t);
      const dPast = Math.abs((now - targetAgo) - t);
      if (dNow < minDeltaNow){ minDeltaNow = dNow; current = p; }
      if (dPast < minDeltaPast){ minDeltaPast = dPast; past = p; }
    }
    if (current && past){
      return ((current - past) / past) * 100;
    }
    return null;
  }

  function normalizeItem(raw){
    // Essaie de normaliser diffÃ©rentes structures venant du worker
    const sym = raw.symbol || raw.ticker || raw.base || raw.code || raw.id || raw.slug || '';
    const name = raw.name || raw.base_name || raw.asset || raw.title || sym;
    const price = Number(raw.price || raw.last || raw.rate || raw.spot || raw.current_price || raw.p || raw.close);
    const vol = Number(raw.volume_24h || raw.vol24h || raw.volume || raw.quote_volume || raw.v);
    return { ...raw, sym, name, price, vol };
  }

  function toCSV(rows){
    const header = ['symbol','name','price_usd','pct','volume_24h'];
    const lines = [header.join(',')];
    for (const r of rows){
      const cells = [r.sym, r.name?.replaceAll(',',' '), r.price?.toString() ?? '', r.pct?.toFixed(4) ?? '', r.vol?.toString() ?? ''];
      lines.push(cells.join(','));
    }
    return lines.join('\n');
  }

  // ====== DATA FLOW ======
  const statusEl = document.getElementById('status');
  const listEl = document.getElementById('list');
  const windowSelect = document.getElementById('windowSelect');
  const thresholdInput = document.getElementById('thresholdInput');
  const refreshBtn = document.getElementById('refreshBtn');
  const csvBtn = document.getElementById('csvBtn');

  let timer = null;

  async function fetchWorker(windowValue){
    // Essaie d'appeler le worker avec un paramÃ¨tre de fenÃªtre, sinon sans
    const url = new URL(WORKER_URL);
    url.searchParams.set('window', windowValue);
    url.searchParams.set('limit', '300'); // si votre worker le supporte

    const tryUrls = [url.toString(), WORKER_URL];
    for (const u of tryUrls){
      try {
        const t0 = performance.now();
        statusEl.textContent = `Chargementâ€¦ (${windowValue})`;
        const res = await fetch(u, {cache:'no-store'});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const dt = (performance.now() - t0).toFixed(0);
        statusEl.textContent = `DonnÃ©es reÃ§ues en ${dt} ms`;
        return data;
      } catch(e){
        console.warn('Ã‰chec sur', u, e);
      }
    }
    throw new Error('Impossible de joindre le worker');
  }

  function render(rows){
    listEl.innerHTML = '';
    if (!rows || rows.length === 0){
      listEl.innerHTML = `<div class="card">Aucun actif ne dÃ©passe le seuil spÃ©cifiÃ©.</div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div>
          <div class="sym">${r.sym || ''}</div>
          <div class="name">${r.name || ''}</div>
          <div class="footer">
            <span class="chip">${r.window}</span>
            <span class="small">Vol 24h: ${Number.isFinite(r.vol) ? fmt.format(r.vol) : 'â€”'}</span>
          </div>
        </div>
        <div class="right">
          <div class="price">${Number.isFinite(r.price) ? money.format(r.price) : 'â€”'}</div>
          <div class="pct ${r.pct>=0?'up':'down'}">${Number.isFinite(r.pct) ? r.pct.toFixed(2)+'%' : 'â€”'}</div>
        </div>
      `;
      frag.appendChild(card);
    });
    listEl.appendChild(frag);
  }

  async function refresh(){
    const windowValue = windowSelect.value;
    const threshold = Number(thresholdInput.value) || 1;

    try{
      const raw = await fetchWorker(windowValue);
      // Supporte soit un tableau direct, soit un objet { data: [...] }
      const arr = Array.isArray(raw) ? raw : (raw.data || raw.items || raw.result || []);

      const rows = [];
      for (const item of arr){
        const n = normalizeItem(item);
        // prix requis
        if (!Number.isFinite(n.price)) continue;

        let pct = pickPct(n, windowValue);
        if (pct === null){
          pct = pctFromHistory(n, windowValue);
        }
        if (pct === null) continue; // pas de % exploitable

        if (pct >= threshold){
          rows.push({ ...n, pct, window: windowValue });
        }
      }

      // Tri dÃ©croissant par %
      rows.sort((a,b)=>b.pct - a.pct);

      render(rows);
      statusEl.textContent = `Affichage: ${rows.length} actifs (seuil â‰¥ ${threshold}%, fenÃªtre ${windowValue})`;
      return rows;
    }catch(e){
      console.error(e);
      statusEl.textContent = `Erreur: ${e.message}`;
      render([]);
      return [];
    }
  }

  refreshBtn.addEventListener('click', refresh);
  windowSelect.addEventListener('change', ()=>{ refresh(); });
  thresholdInput.addEventListener('change', ()=>{ refresh(); });

  csvBtn.addEventListener('click', async()=>{
    const windowValue = windowSelect.value;
    const rows = await refresh();
    const csv = toCSV(rows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `crypto_filtered_${windowValue}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Auto-refresh toutes les 5 minutes
  function startTimer(){
    if (timer) clearInterval(timer);
    timer = setInterval(refresh, 5*60*1000);
  }
  startTimer();
  refresh();
  </script>
</body>
</html>
